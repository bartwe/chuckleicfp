#!/usr/bin/env python
# -*- coding: utf-8 -*-
# generated by wxGlade 0.6.3 on Sat Jul  7 16:15:07 2012

import wx, sys

from pprint import pprint

from ctypes import *

libicfp = CDLL('./libicfp.so')
data_t = POINTER(c_int)
buf_t = POINTER(c_char)
libicfp.Init.argtypes = (c_char_p,)
libicfp.Init.restype = data_t
libicfp.GetData.argtypes = data_t, POINTER(c_int), POINTER(c_int)
libicfp.GetData.restype = POINTER(c_char)
libicfp.DoMove.argtypes = data_t, c_char
libicfp.DoMove.restype = None

# begin wxGlade: extracode
# end wxGlade


class Projection(wx.Control):
    def __init__(self, *a, **kw):
        wx.Control.__init__(self, *a, **kw)
        self.Bind(wx.EVT_PAINT, self.OnPaint)
        self.Bind(wx.EVT_CHAR, self.OnKey)

        self.bmp = {}
        self.bmp[' '] =  wx.Bitmap('images/empty.png')
        self.bmp['#'] =  wx.Bitmap('images/wall.png')
        self.bmp['*'] =  wx.Bitmap('images/rock.png')
        self.bmp['R'] =  wx.Bitmap('images/robot.png')
        self.bmp['L'] =  wx.Bitmap('images/lift.png')
        self.bmp['.'] =  wx.Bitmap('images/earth.png')
        self.bmp['\\'] = wx.Bitmap('images/lambda.png')
        self.bmp['O'] =  wx.Bitmap('images/lift.png')

        if len(sys.argv) > 1:
            fn = sys.argv[1]
        else:
            fn = None
        self.data = libicfp.Init(fn)
        xx = c_int()
        yy = c_int()
        self.maze = libicfp.GetData(self.data, pointer(xx), pointer(yy))

        self.x = xx.value
        self.y = yy.value

        print self.x, self.y

    def clean(self):
        self.data.Clean()

    def OnPaint(self, e):
        dc = wx.PaintDC(self)
        p = self.GetParent()

        BMS = 10
        for x in range(self.x):
            for y in range(self.y):
                cell = self.maze[(self.y-y-1)*self.x + x]
                dc.DrawBitmap(self.bmp[cell], x*BMS, y*BMS)

    def OnKey(self, e):
        kc = e.GetKeyCode()
        char = unichr(kc)
        p = self.GetParent()

        kc2char = {
                wx.WXK_UP: 'U',
                wx.WXK_DOWN: 'D',
                wx.WXK_LEFT: 'L',
                wx.WXK_RIGHT: 'R',
                }

        if kc in kc2char:
            libicfp.DoMove(self.data, kc2char[kc])
        else:
            print 'Unknown key: %d (%r)' % (kc, char)
            e.Skip()
            return

        self.Refresh()

class MyFrame(wx.Frame):
    def __init__(self, *args, **kwds):
        # begin wxGlade: MyFrame.__init__
        kwds["style"] = wx.DEFAULT_FRAME_STYLE | wx.FULL_REPAINT_ON_RESIZE
        wx.Frame.__init__(self, *args, **kwds)
        self.projection = Projection(self, -1)

        self.__set_properties()
        self.__do_layout()
        # end wxGlade

    def __set_properties(self):
        # begin wxGlade: MyFrame.__set_properties
        self.SetTitle("ICFP 2012 viewer")
        # end wxGlade

    def __do_layout(self):
        # begin wxGlade: MyFrame.__do_layout
        sizer_1 = wx.BoxSizer(wx.HORIZONTAL)
        sizer_1.Add(self.projection, 1, wx.EXPAND, 0)
        self.SetSizer(sizer_1)
        sizer_1.Fit(self)
        self.Layout()
        # end wxGlade

# end of class MyFrame


if __name__ == "__main__":
    app = wx.PySimpleApp(0)
    wx.InitAllImageHandlers()
    frame = MyFrame(None, -1, "")
    app.SetTopWindow(frame)
    frame.Show()
    app.MainLoop()
