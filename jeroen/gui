#!/usr/bin/env python
# -*- coding: utf-8 -*-
# generated by wxGlade 0.6.3 on Sat Jul  7 16:15:07 2012

import wx, sys, os

from pprint import pprint

from ctypes import *

import libloader

libicfp = libloader.LoadLibrary()

# begin wxGlade: extracode
# end wxGlade


class Projection(wx.Control):
    def __init__(self, *a, **kw):
        wx.Control.__init__(self, *a, **kw)
        self.Bind(wx.EVT_PAINT, self.OnPaint)
        self.Bind(wx.EVT_CHAR, self.OnKey)

        imgdir = os.path.join(os.path.dirname(__file__), 'images')
        self.bmp = {}
        self.bmp[' '] =  self.bmp[chr(25)] = wx.Bitmap(imgdir + '/empty.png')
        self.bmp['#'] =  self.bmp[chr(1)] = wx.Bitmap(imgdir + '/wall.png')
        self.bmp['*'] =  self.bmp[chr(2)] = wx.Bitmap(imgdir + '/rock.png')
        self.bmp['R'] =  self.bmp[chr(0)] = wx.Bitmap(imgdir + '/robot.png')
        self.bmp['L'] =  self.bmp[chr(4)] = wx.Bitmap(imgdir + '/lift.png')
        self.bmp['.'] =  self.bmp[chr(6)] = wx.Bitmap(imgdir + '/earth.png')
        self.bmp['\\'] = self.bmp[chr(3)] = wx.Bitmap(imgdir + '/lambda.png')
        self.bmp['O'] =  self.bmp[chr(5)] = wx.Bitmap(imgdir + '/lift-open.png')
        self.bmp['A'] =  self.bmp[chr(7)] = wx.Bitmap(imgdir + '/tramp.png')
        self.bmp['B'] =  self.bmp[chr(8)] = wx.Bitmap(imgdir + '/tramp.png')
        self.bmp['C'] =  self.bmp[chr(9)] = wx.Bitmap(imgdir + '/tramp.png')
        self.bmp['D'] =  self.bmp[chr(10)] = wx.Bitmap(imgdir + '/tramp.png')
        self.bmp['E'] =  self.bmp[chr(11)] = wx.Bitmap(imgdir + '/tramp.png')
        self.bmp['F'] =  self.bmp[chr(12)] = wx.Bitmap(imgdir + '/tramp.png')
        self.bmp['G'] =  self.bmp[chr(13)] = wx.Bitmap(imgdir + '/tramp.png')
        self.bmp['H'] =  self.bmp[chr(14)] = wx.Bitmap(imgdir + '/tramp.png')
        self.bmp['I'] =  self.bmp[chr(15)] = wx.Bitmap(imgdir + '/tramp.png')
        self.bmp['1'] =  self.bmp[chr(16)] = wx.Bitmap(imgdir + '/target.png')
        self.bmp['2'] =  self.bmp[chr(17)] = wx.Bitmap(imgdir + '/target.png')
        self.bmp['3'] =  self.bmp[chr(18)] = wx.Bitmap(imgdir + '/target.png')
        self.bmp['4'] =  self.bmp[chr(19)] = wx.Bitmap(imgdir + '/target.png')
        self.bmp['5'] =  self.bmp[chr(20)] = wx.Bitmap(imgdir + '/target.png')
        self.bmp['6'] =  self.bmp[chr(21)] = wx.Bitmap(imgdir + '/target.png')
        self.bmp['7'] =  self.bmp[chr(22)] = wx.Bitmap(imgdir + '/target.png')
        self.bmp['8'] =  self.bmp[chr(23)] = wx.Bitmap(imgdir + '/target.png')
        self.bmp['9'] =  self.bmp[chr(24)] = wx.Bitmap(imgdir + '/target.png')

        if len(sys.argv) > 1:
            fn = sys.argv[1]
        else:
            fn = None
        self.data = libicfp.Init(fn)
        xx = c_int()
        yy = c_int()
        self.maze = libicfp.GetData(self.data, pointer(xx), pointer(yy))

        self.x = xx.value
        self.y = yy.value

        self.safezone = None

        print self.x, self.y

    def clean(self):
        self.data.Clean()

    def OnPaint(self, e):
        dc = wx.PaintDC(self)
        p = self.GetParent()

        buf = (c_char * 1024)()
        waterlevel = c_int()
        libicfp.GetInfo(self.data, buf, 1024, waterlevel)
        waterlevel = waterlevel.value
        info = buf.value

        STATUSLINE = 30
        BMS = 10
        for x in range(self.x):
            for y in range(self.y):
                cellidx = (self.y-y-1)*self.x + x
                cell = self.maze[cellidx]
                dc.DrawBitmap(self.bmp[cell], x*BMS, STATUSLINE + y*BMS)
                if self.safezone is not None:
                    if ord(self.safezone[cellidx]):
                        dc.DrawBitmap(self.bmp['R'], x*BMS, STATUSLINE + y*BMS)

        dc.DrawLabel(info, (0, 0, 200, 30))
        waterlevelpix = STATUSLINE + BMS * (self.y-waterlevel)
        dc.SetPen(wx.Pen('BLUE', 3))
        dc.DrawLine(0, waterlevelpix, self.x*BMS, waterlevelpix)


    def OnKey(self, e):
        kc = e.GetKeyCode()
        char = unichr(kc)
        p = self.GetParent()

        kc2char = {
                wx.WXK_UP: 'U',
                wx.WXK_DOWN: 'D',
                wx.WXK_LEFT: 'L',
                wx.WXK_RIGHT: 'R',
                }

        if kc in kc2char:
            libicfp.DoMove(self.data, kc2char[kc])
        elif char.lower() == 's':
            if self.safezone is None:
                self.safezone = libicfp.GetSafeZone(self.data)
            else:
                self.safezone = None
        else:
            print 'Unknown key: %d (%r)' % (kc, char)
            e.Skip()
            return

        self.Refresh()

class MyFrame(wx.Frame):
    def __init__(self, *args, **kwds):
        # begin wxGlade: MyFrame.__init__
        kwds["style"] = wx.DEFAULT_FRAME_STYLE | wx.FULL_REPAINT_ON_RESIZE
        wx.Frame.__init__(self, *args, **kwds)
        self.projection = Projection(self, -1)

        self.__set_properties()
        self.__do_layout()
        # end wxGlade

    def __set_properties(self):
        # begin wxGlade: MyFrame.__set_properties
        self.SetTitle("ICFP 2012 viewer")
        # end wxGlade

    def __do_layout(self):
        # begin wxGlade: MyFrame.__do_layout
        sizer_1 = wx.BoxSizer(wx.HORIZONTAL)
        sizer_1.Add(self.projection, 1, wx.EXPAND, 0)
        self.SetSizer(sizer_1)
        sizer_1.Fit(self)
        self.Layout()
        # end wxGlade

# end of class MyFrame


if __name__ == "__main__":
    app = wx.PySimpleApp(0)
    wx.InitAllImageHandlers()
    frame = MyFrame(None, -1, "")
    app.SetTopWindow(frame)
    frame.Show()
    app.MainLoop()
